<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>组件测试 | Jest 实践指南</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="从基础实战到测试思维，带你全面了解和掌握前端测试">
    <meta name="keywords" content="jest, testing, typescript, eslint, 前端, 测试">
    <meta name="author" content="海怪">
    
    <link rel="preload" href="/jest-tutorial/assets/css/0.styles.3af8d58b.css" as="style"><link rel="preload" href="/jest-tutorial/assets/js/app.dfa51a05.js" as="script"><link rel="preload" href="/jest-tutorial/assets/js/2.03a6ea53.js" as="script"><link rel="preload" href="/jest-tutorial/assets/js/9.89aee88f.js" as="script"><link rel="prefetch" href="/jest-tutorial/assets/js/10.a5fde7bb.js"><link rel="prefetch" href="/jest-tutorial/assets/js/11.0e357828.js"><link rel="prefetch" href="/jest-tutorial/assets/js/12.d675dd1f.js"><link rel="prefetch" href="/jest-tutorial/assets/js/13.ff10ad5b.js"><link rel="prefetch" href="/jest-tutorial/assets/js/14.1903c055.js"><link rel="prefetch" href="/jest-tutorial/assets/js/15.b6d0931c.js"><link rel="prefetch" href="/jest-tutorial/assets/js/16.6a29a918.js"><link rel="prefetch" href="/jest-tutorial/assets/js/17.d31ffd05.js"><link rel="prefetch" href="/jest-tutorial/assets/js/18.8509fe90.js"><link rel="prefetch" href="/jest-tutorial/assets/js/19.0c05163f.js"><link rel="prefetch" href="/jest-tutorial/assets/js/20.55eba354.js"><link rel="prefetch" href="/jest-tutorial/assets/js/21.5edf9c70.js"><link rel="prefetch" href="/jest-tutorial/assets/js/22.77f22525.js"><link rel="prefetch" href="/jest-tutorial/assets/js/23.3e072b91.js"><link rel="prefetch" href="/jest-tutorial/assets/js/24.d8220887.js"><link rel="prefetch" href="/jest-tutorial/assets/js/25.1c35c041.js"><link rel="prefetch" href="/jest-tutorial/assets/js/26.d4b69710.js"><link rel="prefetch" href="/jest-tutorial/assets/js/3.9fccf44d.js"><link rel="prefetch" href="/jest-tutorial/assets/js/4.2d7ecec7.js"><link rel="prefetch" href="/jest-tutorial/assets/js/5.b1a8dea6.js"><link rel="prefetch" href="/jest-tutorial/assets/js/6.ee81796b.js"><link rel="prefetch" href="/jest-tutorial/assets/js/7.45845233.js"><link rel="prefetch" href="/jest-tutorial/assets/js/8.8fda6116.js">
    <link rel="stylesheet" href="/jest-tutorial/assets/css/0.styles.3af8d58b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/jest-tutorial/" class="home-link router-link-active"><img src="/jest-tutorial/images/logo.png" alt="Jest 实践指南" class="logo"> <span class="site-name can-hide">Jest 实践指南</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/haixiangyan/jest-tutorial/issues" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Issue
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/haixiangyan/jest-tutorial" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/haixiangyan/jest-tutorial/issues" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Issue
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/haixiangyan/jest-tutorial" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>介绍</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/jest-tutorial/" aria-current="page" class="sidebar-link">小书介绍</a></li><li><a href="/jest-tutorial/intro/why-test/" class="sidebar-link">为什么要测试</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>基础实践</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/jest-tutorial/basic/getting-started/" class="sidebar-link">起步</a></li><li><a href="/jest-tutorial/basic/transformer/" class="sidebar-link">转译器</a></li><li><a href="/jest-tutorial/basic/test-environment/" class="sidebar-link">测试环境</a></li><li><a href="/jest-tutorial/basic/navigation/" class="sidebar-link">Mock 网页地址</a></li><li><a href="/jest-tutorial/basic/tdd/" class="sidebar-link">测试驱动开发</a></li><li><a href="/jest-tutorial/basic/mock-timer/" class="sidebar-link">Mock Timer</a></li><li><a href="/jest-tutorial/basic/config-react/" class="sidebar-link">引入 React（纯配置）</a></li><li><a href="/jest-tutorial/basic/snapshot-test/" class="sidebar-link">快照测试</a></li><li><a href="/jest-tutorial/basic/component-test/" aria-current="page" class="active sidebar-link">组件测试</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/jest-tutorial/basic/component-test/#需求" class="sidebar-link">需求</a></li><li class="sidebar-sub-header"><a href="/jest-tutorial/basic/component-test/#less-的引入问题" class="sidebar-link">Less 的引入问题</a></li><li class="sidebar-sub-header"><a href="/jest-tutorial/basic/component-test/#更多-matchers" class="sidebar-link">更多 Matchers</a></li><li class="sidebar-sub-header"><a href="/jest-tutorial/basic/component-test/#三种-mock-思路" class="sidebar-link">三种 Mock 思路</a></li><li class="sidebar-sub-header"><a href="/jest-tutorial/basic/component-test/#如何取舍" class="sidebar-link">如何取舍</a></li><li class="sidebar-sub-header"><a href="/jest-tutorial/basic/component-test/#如何避免测试用户" class="sidebar-link">如何避免测试用户</a></li><li class="sidebar-sub-header"><a href="/jest-tutorial/basic/component-test/#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/jest-tutorial/basic/how-to-mock/" class="sidebar-link">Mock 大全</a></li><li><a href="/jest-tutorial/basic/redux-test/" class="sidebar-link">Redux 测试</a></li><li><a href="/jest-tutorial/basic/hook-test/" class="sidebar-link">React Hook 测试</a></li><li><a href="/jest-tutorial/basic/static-tool/" class="sidebar-link">静态检查工具</a></li><li><a href="/jest-tutorial/basic/performance/" class="sidebar-link">Jest 性能优化</a></li><li><a href="/jest-tutorial/basic/automation/" class="sidebar-link">自动化测试</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>测试思路</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/jest-tutorial/thoughts/articles.html" class="sidebar-link">所有文章</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>最后</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/jest-tutorial/end/github.html" class="sidebar-link">Github 项目</a></li><li><a href="/jest-tutorial/end/end.html" class="sidebar-link">结语</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="组件测试"><a href="#组件测试" class="header-anchor">#</a> 组件测试</h1> <p>终于到正片了，这一章我们来讲讲组件测试中的一些技巧和策略吧。</p> <h2 id="需求"><a href="#需求" class="header-anchor">#</a> 需求</h2> <p>首先，我们还是以一个需求来开始这一章：<strong>实现一个 <code>AuthButton</code>，通过 <code>getLoginState</code> 获取当前用户的身份并在按钮中展示用户身份。</strong></p> <p>简单分析一下这个需求：</p> <ol><li>实现 <code>AuthButton</code> 业务组件</li> <li>在 API 函数 <code>getLoginState</code> 发请求获取用户身份</li> <li>把 Http 请求的返回 <code>loginStateResponse</code> 展示到按钮上</li></ol> <p>我们先来安装一下 <code>axios</code>：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">npm</span> i axios@0.26.1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后添加 <code>src/apis/user.ts</code>，里面写发送获取用户角色身份的 Http 请求：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">&quot;axios&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 用户角色身份</span>
<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">UserRoleType</span> <span class="token operator">=</span> <span class="token string">&quot;user&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 返回</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">GetUserRoleRes</span> <span class="token punctuation">{</span>
  userType<span class="token operator">:</span> UserRoleType<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 获取用户角色身份</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getUserRole</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> axios<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span>GetUserRoleRes<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&quot;https://mysite.com/api/role&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>添加业务组件 <code>src/components/AuthButton/index.tsx</code>：</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">// src/components/AuthButton/index.tsx</span>
<span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token constant">FC</span><span class="token punctuation">,</span> useEffect<span class="token punctuation">,</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Button<span class="token punctuation">,</span> ButtonProps<span class="token punctuation">,</span> message <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;antd&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> classnames <span class="token keyword">from</span> <span class="token string">&quot;classnames&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">&quot;./styles.module.less&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> getUserRole<span class="token punctuation">,</span> UserRoleType <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;apis/user&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">type</span> <span class="token class-name">Props</span> <span class="token operator">=</span> ButtonProps<span class="token punctuation">;</span>

<span class="token comment">// 身份文案 Mapper</span>
<span class="token keyword">const</span> mapper<span class="token operator">:</span> Record<span class="token operator">&lt;</span>UserRoleType<span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  user<span class="token operator">:</span> <span class="token string">&quot;普通用户&quot;</span><span class="token punctuation">,</span>
  admin<span class="token operator">:</span> <span class="token string">&quot;管理员&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> AuthButton<span class="token operator">:</span> <span class="token constant">FC</span><span class="token operator">&lt;</span>Props<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> children<span class="token punctuation">,</span> className<span class="token punctuation">,</span> <span class="token operator">...</span>restProps <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token punctuation">[</span>userType<span class="token punctuation">,</span> setUserType<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token generic-function"><span class="token function">useState</span><span class="token generic class-name"><span class="token operator">&lt;</span>UserRoleType<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 获取用户身份并设置</span>
  <span class="token keyword">const</span> <span class="token function-variable function">getLoginState</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getUserRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setUserType</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>userType<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">getLoginState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> message<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Button</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token operator">...</span>restProps<span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> styles<span class="token punctuation">.</span>authButton<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span>mapper<span class="token punctuation">[</span>userType<span class="token operator">!</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Button</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> AuthButton<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>这里我们还不忘搞点花里胡哨，引入了 <code>src/components/AuthButton/styles.module.less</code>：</p> <div class="language-less line-numbers-mode"><pre class="language-less"><code><span class="token comment">// src/components/AuthButton/styles.module.less</span>
<span class="token selector">.authButton</span> <span class="token punctuation">{</span>
  <span class="token property">border</span><span class="token punctuation">:</span> 1px solid red<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>最后在 <code>App.tsx</code> 里使用一下：</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">// src/App.tsx</span>
<span class="token keyword">const</span> <span class="token function-variable function">App</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>section</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">AuthButton</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">登录</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">AuthButton</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>section</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="less-的引入问题"><a href="#less-的引入问题" class="header-anchor">#</a> Less 的引入问题</h2> <p>好，现在我们一个一个问题来看。写完上面的代码后，TS 首先受不了报错：</p> <p><img src="/jest-tutorial/assets/img/ts-less-error.d7c3fa03.png" alt=""></p> <p>我们需要在全局类型声明文件 <code>src/types/global.d.ts</code> 里添加 <code>.less</code> 文件的类型定义：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/types/global.d.ts</span>
<span class="token keyword">declare</span> <span class="token keyword">module</span> <span class="token string">&quot;*.less&quot;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> content<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
  <span class="token keyword">export</span> <span class="token keyword">default</span> content<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>相信大家都能看懂 <code>AuthButton</code> 的代码，就不展示页面的情况了，下面主要来讨论测试用例的问题。
创建一个用例 <code>tests/components/AuthButton/simple.test.tsx</code>：</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">// tests/components/AuthButton/simple.test.tsx</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> render<span class="token punctuation">,</span> screen <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@testing-library/react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> AuthButton <span class="token keyword">from</span> <span class="token string">&quot;components/AuthButton&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'AuthButton'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'可以正常展示'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">AuthButton</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">登录</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">AuthButton</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>screen<span class="token punctuation">.</span><span class="token function">getByText</span><span class="token punctuation">(</span><span class="token string">'登录'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeDefined</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>执行一下，直接报错：</p> <p><img src="/jest-tutorial/assets/img/jest-less-error.3d9957bb.png" alt=""></p> <p>前面的章节说了 <strong>Jest 不会转译任何内容</strong>，因此我们一直用 <code>tsc</code> 来转译 TypeScript。<strong>由于 <code>tsc</code> 看不懂引入的 <code>.less</code>，导致了 <code>Unexpected Token</code> 报错。</strong></p> <p>相信有的同学说：<em>刚刚配置 React 时，不是有一个 <code>webpack.config.js</code> 配置了 <code>less-loader</code> 了么？为什么还是会报错？</em></p> <p><strong>很简单，Jest 只是 Test Runner，只负责跑测试，<code>tsc</code> 负责转译 <code>.ts</code> 文件，<code>webpack</code> 则作为脚手架用于跑项目的工具，所以这三者本身不存在任何交集。</strong>
只不过，中间 <code>ts-jest</code> 把 <code>jest</code> 和 <code>tsc</code> 联系起来，<code>ts-loader</code> 则把 <code>webpack</code> 和 <code>tsc</code> 联系在了一起。所以无论你的 Webpack 配得怎么天花乱坠，Jest 根本不看。</p> <p>那问题要怎么解决呢？<strong>比较推荐的方法是把 <code>.less</code> 转译成空文件。</strong> 这在 <a href="https://stackoverflow.com/questions/54627028/jest-unexpected-token-when-importing-css" target="_blank" rel="noopener noreferrer">StackOverflow 上有很多例子<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ：</p> <p><img src="/jest-tutorial/assets/img/stackoverflow.9d415144.png" alt=""></p> <p>除了 <code>.less</code> 文件，我们还要对非 JS 静态资源做转译，比如 <code>jpg</code>, <code>svg</code>, <code>png</code> 等等（这些不会影响测试）。
这里推荐使用 <a href="https://www.npmjs.com/package/jest-transform-stub" target="_blank" rel="noopener noreferrer">jest-transform-stub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 这个库：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">npm</span> i -D jest-transform-stub@2.0.0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后在 <code>jest.config.js</code> 里添加转译配置：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// jest.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token literal-property property">transform</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;.+\\.(css|styl|less|sass|scss|png|jpg|ttf|woff|woff2)$&quot;</span><span class="token operator">:</span> <span class="token string">&quot;jest-transform-stub&quot;</span>
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>现在再来跑测试就会发现测试通过。</p> <h2 id="更多-matchers"><a href="#更多-matchers" class="header-anchor">#</a> 更多 Matchers</h2> <p>不知道你会不会觉得 <code>expect(screen.getByText('登录')).toBeDefined();</code> 有点不靠谱啊。假如 <code>getByText</code> 返回的是一个 <code>null</code>，这样一来就算找不到元素依然会测试通过。
实际上，我们更希望的断言是：判断带有 “登录” 的元素是否渲染出来，而不是看拿到的元素是否为 <code>undefined</code> 或者 <code>null</code>。</p> <p><strong>这种要判断 XXX 的东西，我们称之为 Matcher（中文翻译为匹配器，个人觉得翻译很烂，记住 Matcher 就好）</strong>。
正好 <a href="https://www.npmjs.com/package/@testing-library/jest-dom" target="_blank" rel="noopener noreferrer">@testing-library/jest-dom<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 这个库提供了很多关于 DOM 的 Matcher API：</p> <ul><li>toBeDisabled</li> <li>toBeEnabled</li> <li>toBeEmptyDOMElement</li> <li>toBeInTheDocument</li> <li>toBeInvalid</li> <li>toBeRequired</li> <li>toBeValid</li> <li>toBeVisible</li> <li>toContainElement</li> <li>toContainHTML</li> <li>toHaveAccessibleDescription</li> <li>toHaveAccessibleName</li> <li>toHaveAttribute</li> <li>toHaveClass</li> <li>toHaveFocus</li> <li>toHaveFormValues</li> <li>toHaveStyle</li> <li>toHaveTextContent</li> <li>toHaveValue</li> <li>toHaveDisplayValue</li> <li>toBeChecked</li> <li>toBePartiallyChecked</li> <li>toHaveErrorMessage</li></ul> <p>下面我们安装一下：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">npm</span> i -D @testing-library/jest-dom@5.16.4
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后在 <code>tests/jest-setup.ts</code> 里引入一下：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// tests/jest-setup.ts</span>
<span class="token keyword">import</span> <span class="token string">'@testing-library/jest-dom'</span>
<span class="token comment">// ...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>同时，要在 <code>tsconfig.json</code> 里引入这个库的类型声明：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;compilerOptions&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;types&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;node&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jest&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;@testing-library/jest-dom&quot;</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>然后我们的用例就可以写成这样了：</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'AuthButton'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'可以正常展示'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">AuthButton</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">登录</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">AuthButton</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>screen<span class="token punctuation">.</span><span class="token function">getByText</span><span class="token punctuation">(</span><span class="token string">'登录'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeInTheDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>这样一来，我们就不用担心 <code>getByText</code> 返回值了。</p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>如果你的项目报了 <code>Entry point of type library '@testing-library/jest-dom' specified in compilerOptions</code> 这个错误，
可以按照 <a href="https://github.com/haixiangyan/jest-tutorial/issues/26" target="_blank" rel="noopener noreferrer">这个 Issue<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 来修复。</p></div> <h2 id="三种-mock-思路"><a href="#三种-mock-思路" class="header-anchor">#</a> 三种 Mock 思路</h2> <p>上面只是一个 Demo 测试，现在我们来测这个组件的功能。</p> <h3 id="mock-axios"><a href="#mock-axios" class="header-anchor">#</a> Mock Axios</h3> <p>相信大家看过不少教 Jest Mock 的文章，它们经常用的第一个例子就是 Mock <code>axios</code>。这里也用了 <code>axios</code> 发请求，我们可以来 Mock 一下。
添加 <code>tests/components/AuthButton/mockAxios.test.tsx</code>：</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">// tests/components/AuthButton/mockAxios.test.tsx</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">&quot;axios&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> render<span class="token punctuation">,</span> screen <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@testing-library/react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> AuthButton <span class="token keyword">from</span> <span class="token string">&quot;components/AuthButton&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 更偏向细节，效果并不好</span>
<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&quot;AuthButton Mock Axios&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&quot;可以正确展示普通用户按钮内容&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    jest<span class="token punctuation">.</span><span class="token function">spyOn</span><span class="token punctuation">(</span>axios<span class="token punctuation">,</span> <span class="token string">&quot;get&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockResolvedValueOnce</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// 其它的实现...</span>
      data<span class="token operator">:</span> <span class="token punctuation">{</span> userType<span class="token operator">:</span> <span class="token string">&quot;user&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">AuthButton</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">你好</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">AuthButton</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token keyword">await</span> screen<span class="token punctuation">.</span><span class="token function">findByText</span><span class="token punctuation">(</span><span class="token string">&quot;普通用户你好&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeInTheDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&quot;可以正确展示管理员按钮内容&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    jest<span class="token punctuation">.</span><span class="token function">spyOn</span><span class="token punctuation">(</span>axios<span class="token punctuation">,</span> <span class="token string">&quot;get&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockResolvedValueOnce</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// 其它的实现...</span>
      data<span class="token operator">:</span> <span class="token punctuation">{</span> userType<span class="token operator">:</span> <span class="token string">&quot;admin&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">AuthButton</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">你好</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">AuthButton</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token keyword">await</span> screen<span class="token punctuation">.</span><span class="token function">findByText</span><span class="token punctuation">(</span><span class="token string">&quot;管理员你好&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeInTheDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>上面我们分别对两个用例的 <code>axios.get</code> 进行了 Mock，使得一个 Mock 返回 <code>user</code>，另一个 Mock 返回 <code>admin</code>。
最后，在这两个用例里分别断言 <code>&lt;AuthButton/&gt;</code> 的渲染内容。</p> <p>Mock <code>axios</code> 确实是一个方法，但只有这种方法么？No！</p> <h3 id="mock-api-函数"><a href="#mock-api-函数" class="header-anchor">#</a> Mock API 函数</h3> <p>另一种方法是 Mock <code>apis/user.ts</code> 里的 <code>getUserRole</code> API 函数，一样能达到相同的效果：</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">// tests/components/AuthButton/mockGetUserRole.test.tsx</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> render<span class="token punctuation">,</span> screen <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@testing-library/react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> AuthButton <span class="token keyword">from</span> <span class="token string">&quot;components/AuthButton&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// 注意：这里要写成 * as userUtils！！！</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> userUtils <span class="token keyword">from</span> <span class="token string">&quot;apis/user&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AxiosResponse <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;axios&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 也很偏向细节，效果也不好</span>
<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&quot;AuthButton Mock Axios&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&quot;可以正确展示普通用户按钮内容&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    jest<span class="token punctuation">.</span><span class="token function">spyOn</span><span class="token punctuation">(</span>userUtils<span class="token punctuation">,</span> <span class="token string">&quot;getUserRole&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockResolvedValueOnce</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// 其它的实现...</span>
      data<span class="token operator">:</span> <span class="token punctuation">{</span> userType<span class="token operator">:</span> <span class="token string">&quot;user&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token keyword">as</span> AxiosResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">AuthButton</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">你好</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">AuthButton</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token keyword">await</span> screen<span class="token punctuation">.</span><span class="token function">findByText</span><span class="token punctuation">(</span><span class="token string">&quot;普通用户你好&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeInTheDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&quot;可以正确展示管理员按钮内容&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    jest<span class="token punctuation">.</span><span class="token function">spyOn</span><span class="token punctuation">(</span>userUtils<span class="token punctuation">,</span> <span class="token string">&quot;getUserRole&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockResolvedValueOnce</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// 其它的实现...</span>
      data<span class="token operator">:</span> <span class="token punctuation">{</span> userType<span class="token operator">:</span> <span class="token string">&quot;admin&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token keyword">as</span> AxiosResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">AuthButton</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">你好</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">AuthButton</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token keyword">await</span> screen<span class="token punctuation">.</span><span class="token function">findByText</span><span class="token punctuation">(</span><span class="token string">&quot;管理员你好&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeInTheDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>和第一种方法类似，我们依然监听了某个函数（这里是 <code>getUserRole</code>），通过 Mock 其返回来模拟不同场景。</p> <h3 id="mock-http"><a href="#mock-http" class="header-anchor">#</a> Mock Http</h3> <p>那还有没有别的方法呢？当然有！我们可以不 Mock 任何函数实现，只对 Http 请求进行 Mock！先安装 <a href="https://github.com/mswjs/msw" target="_blank" rel="noopener noreferrer">msw<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ：</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p><a href="https://github.com/mswjs/msw" target="_blank" rel="noopener noreferrer">msw<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 可以拦截指定的 Http 请求，有点类似 <a href="http://mockjs.com/" target="_blank" rel="noopener noreferrer">Mock.js<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ，是做测试时一个非常强大好用的 Http Mock 工具。</p></div> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">npm</span> i -D msw@0.39.2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>先在 <code>tests/mockServer/handlers.ts</code> 里添加 Http 请求的 Mock Handler：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> rest <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;msw&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> handlers <span class="token operator">=</span> <span class="token punctuation">[</span>
  rest<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;https://mysite.com/api/role&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">res</span><span class="token punctuation">(</span>
      ctx<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      ctx<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        userType<span class="token operator">:</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> handlers<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>然后在 <code>tests/mockServer/server.ts</code> 里使用这些 <code>handlers</code> 创建 Mock Server 并导出它：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> setupServer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;msw/node&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> handlers <span class="token keyword">from</span> <span class="token string">&quot;./handlers&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">setupServer</span><span class="token punctuation">(</span><span class="token operator">...</span>handlers<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> server<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>最后，在我们的 <code>tests/jest-setup.ts</code> 里使用 Mock Server：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> server <span class="token keyword">from</span> <span class="token string">&quot;./mockServer/server&quot;</span><span class="token punctuation">;</span>

<span class="token function">beforeAll</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">afterEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  server<span class="token punctuation">.</span><span class="token function">resetHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">afterAll</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  server<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>这样一来，在所有测试用例中都能获得 <code>handlers.ts</code> 里的 Mock 返回了。<strong>如果你想在某个测试文件中想单独指定某个接口的 Mock 返回，
可以使用 <code>server.use(mockHandler)</code> 来实现。</strong> 我们以 <code>&lt;AuthButton/&gt;</code> 为例：</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">// tests/components/AuthButton/mockHttp.test.tsx</span>
<span class="token comment">// 更偏向真实用例，效果更好</span>
<span class="token keyword">import</span> server <span class="token keyword">from</span> <span class="token string">&quot;../../mockServer/server&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> rest <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;msw&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> render<span class="token punctuation">,</span> screen <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@testing-library/react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> AuthButton <span class="token keyword">from</span> <span class="token string">&quot;components/AuthButton&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserRoleType <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;apis/user&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 初始化函数</span>
<span class="token keyword">const</span> <span class="token function-variable function">setup</span> <span class="token operator">=</span> <span class="token punctuation">(</span>userType<span class="token operator">:</span> UserRoleType<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  server<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
    rest<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;https://mysite.com/api/role&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">res</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> userType <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&quot;AuthButton Mock Http 请求&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&quot;可以正确展示普通用户按钮内容&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setup</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">AuthButton</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">你好</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">AuthButton</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token keyword">await</span> screen<span class="token punctuation">.</span><span class="token function">findByText</span><span class="token punctuation">(</span><span class="token string">&quot;普通用户你好&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeInTheDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&quot;可以正确展示管理员按钮内容&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setup</span><span class="token punctuation">(</span><span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">AuthButton</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">你好</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">AuthButton</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token keyword">await</span> screen<span class="token punctuation">.</span><span class="token function">findByText</span><span class="token punctuation">(</span><span class="token string">&quot;管理员你好&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeInTheDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>这里声明了一个 <code>setup</code> 函数，用于在每个用例前初始化 Http 请求的 Mock 返回。通过传不同值给 <code>setup</code> 就可以灵活模拟测试场景了。</p> <h2 id="如何取舍"><a href="#如何取舍" class="header-anchor">#</a> 如何取舍</h2> <p>现在我们一共有 3 种 Mock 策略：</p> <ol><li><strong>Mock <code>axios</code></strong></li> <li><strong>Mock API 实现</strong></li> <li><strong>Mock Http 请求</strong></li></ol> <p>到底如何选择呢？你可以停下来思考一两分钟。</p> <p>在说出我的选择前，我们不妨想想我们做测试的初衷是什么。是因为我让你测试才测试？还是因为你要完成那可怜的 100% 覆盖率？再或者是因为没有测试显得你的项目很 Low？都不是！
<strong>无论后端测试也好、前端测试也好，不管你要测什么，测试的目的都是为了让你能对测过的代码充满信心（Confidence）。</strong></p> <p>你可以通过作弊的手法骗过覆盖率，可以通过写一些无聊没有意义的用例骗过你的老板，也可以干脆去掉测试环节，让大家直接在 <code>master</code> 上推代码。即使你能骗过所有人，
你依然无法骗自己 —— 在重构和代码改造时，你仍然不信任写过的代码。那么，<strong>什么样的测试才能提高代码自信呢？很简单：像真实用户那样去测你的代码。</strong></p> <p>这里说的用户一共分为两种：</p> <ol><li><strong>普通用户。</strong> 也即使用网页的人</li> <li><strong>开发者。</strong> 接口使用者、数据消费者、API 调用侠</li></ol> <p>刚接触测试的人很容易犯的一个错误就是：<strong>过度测试代码细节！</strong> 虽然我们经常讨论前端单测，单测不就是白盒么？白盒就是要关注代码细节呀。但是很多时候，特别是在测业务相关逻辑的时候，
<strong>过度关注代码细节无形中会创造第三种用户：测试用户。</strong> 也即，<strong>只有测试用户才会像你测试用例那样使用你的代码/组件/页面。</strong></p> <p>我们回到刚刚的例子，可以看出来 Mock <code>axios</code> 和 Mock <code>getUserRole</code> 都融入很多代码细节，无论对于使用 <code>AuthButton</code> 组件的开发者以及和 <code>AuthButton</code> 交互的用户，
都不应该关注组件里到底用的是哪个接口和调用了哪个函数，这太细节了！这就产生了测试用户，因为只有测试用户才会用假的 <code>axios</code> 和 <code>getUserRole</code> 实现。</p> <p>对于上面两类用户来说，他们感知到的就是管理员和普通用户两个 case，最能模拟出这种感知的就是第三种 Mock —— Mock Http 请求，所以，<strong>在这个例子中，我觉得对 Http 请求 Mock 更合理一些。</strong></p> <p>测试实现细节还有很多缺点，比如，在 Mock <code>getUserRole</code> 这个方法中，如果有人把 <code>getUserRole</code> 重命名成 <code>getUserRoleById</code>，那么你的测试直接就挂了。这就是上一章所说的 <strong>“假错误”</strong>。
对于不熟悉 <code>AuthButton</code> 实现的人来说，要找到测试失败的源头是比较麻烦的。</p> <h2 id="如何避免测试用户"><a href="#如何避免测试用户" class="header-anchor">#</a> 如何避免测试用户</h2> <p>当然，上面说的并不是完全不测代码细节。对于一些工具纯函数是需要深入测好每个 <code>if-else</code> 的，<strong>这是因为这种场景下 “真实用户” 变成了开发者，
所以当然要深入细节来测，这与刚刚说的观点并不冲突。</strong></p> <p><strong>上文观点主要是希望大家避免产生 “测试用户”。</strong> 一旦你的测试面向 “测试用户” 编写，那么你的测试会变得非常冗余，难以维护。一旦要做重构，所有测试都要跟着改。
这也是为什么大家特别讨厌测试的原因。并不是测试影响了你的效率，而是那些差劲的测试代码拖累了你。</p> <p>所以要怎么才能避免测试用户呢？拿到要测的业务代码后，我们要去分析：</p> <ol><li>这段代码的 <strong>真实用户</strong> 是谁？开发者还是普通用户？谁会从中获利？</li> <li>确定了用户后，用测试用例模拟一个相对 <strong>真实的使用场景</strong></li> <li>接下来思考 <strong>为了模拟这个场景</strong>，要做哪些 Mock 操作？</li></ol> <p>带着上面的方法回过头来看 <code>AuthButton</code> 这个例子：</p> <ol><li>用户是谁：这个组件的真实用户更偏向普通用户（个人觉得）</li> <li>使用场景是什么：<code>&lt;AuthButton&gt;登录&lt;/AuthButton&gt;</code></li> <li>存在哪些外部依赖：要把 Http 请求 Mock 掉</li></ol> <p>在真实业务中，开发者一般喜欢用 <code>antd</code> 或者 <code>element-ui</code> 来封装业务组件，对于这些组件我们实际更关注的是交互逻辑，而不是实现逻辑。</p> <p>当然，也有可能你会觉得这里的 “用户” 是开发者，最终选择把 <code>getUserRole</code> Mock 掉。这样做也没问题，<strong>因为测试本来就是一个取舍的过程，不像写业务有一个绝对准确的结果。</strong>
只要你觉得这么测能带给你更强的代码信心，那就放手去写吧！</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>这一章里，我们学到了：</p> <ul><li>可以用 <a href="https://www.npmjs.com/package/jest-transform-stub" target="_blank" rel="noopener noreferrer">jest-transform-stub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 来转译非 JS 静态资源文件</li> <li>可以用 <code>jest.spyOn</code> 来 Mock 对象中的函数</li> <li>在做测试策略的选择时，我们要避免产生测试用户，要面向 <strong>开发者</strong> 和 <strong>普通用户</strong> 来写测试用例</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新:</span> <span class="time">6/14/2022, 7:38:24 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/jest-tutorial/basic/snapshot-test/" class="prev">
        快照测试
      </a></span> <span class="next"><a href="/jest-tutorial/basic/how-to-mock/">
        Mock 大全
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/jest-tutorial/assets/js/app.dfa51a05.js" defer></script><script src="/jest-tutorial/assets/js/2.03a6ea53.js" defer></script><script src="/jest-tutorial/assets/js/9.89aee88f.js" defer></script>
  </body>
</html>
