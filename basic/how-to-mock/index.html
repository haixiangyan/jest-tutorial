<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Mock 大全 | Jest 实践指南</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="从基础实战到测试思维，带你全面了解和掌握前端测试">
    <meta name="keywords" content="jest, testing, typescript, eslint, 前端, 测试">
    <meta name="author" content="海怪">
    
    <link rel="preload" href="/jest-tutorial/assets/css/0.styles.3af8d58b.css" as="style"><link rel="preload" href="/jest-tutorial/assets/js/app.dfa51a05.js" as="script"><link rel="preload" href="/jest-tutorial/assets/js/2.03a6ea53.js" as="script"><link rel="preload" href="/jest-tutorial/assets/js/18.8509fe90.js" as="script"><link rel="prefetch" href="/jest-tutorial/assets/js/10.a5fde7bb.js"><link rel="prefetch" href="/jest-tutorial/assets/js/11.0e357828.js"><link rel="prefetch" href="/jest-tutorial/assets/js/12.d675dd1f.js"><link rel="prefetch" href="/jest-tutorial/assets/js/13.ff10ad5b.js"><link rel="prefetch" href="/jest-tutorial/assets/js/14.1903c055.js"><link rel="prefetch" href="/jest-tutorial/assets/js/15.b6d0931c.js"><link rel="prefetch" href="/jest-tutorial/assets/js/16.6a29a918.js"><link rel="prefetch" href="/jest-tutorial/assets/js/17.d31ffd05.js"><link rel="prefetch" href="/jest-tutorial/assets/js/19.0c05163f.js"><link rel="prefetch" href="/jest-tutorial/assets/js/20.55eba354.js"><link rel="prefetch" href="/jest-tutorial/assets/js/21.5edf9c70.js"><link rel="prefetch" href="/jest-tutorial/assets/js/22.77f22525.js"><link rel="prefetch" href="/jest-tutorial/assets/js/23.3e072b91.js"><link rel="prefetch" href="/jest-tutorial/assets/js/24.d8220887.js"><link rel="prefetch" href="/jest-tutorial/assets/js/25.1c35c041.js"><link rel="prefetch" href="/jest-tutorial/assets/js/26.d4b69710.js"><link rel="prefetch" href="/jest-tutorial/assets/js/3.9fccf44d.js"><link rel="prefetch" href="/jest-tutorial/assets/js/4.2d7ecec7.js"><link rel="prefetch" href="/jest-tutorial/assets/js/5.b1a8dea6.js"><link rel="prefetch" href="/jest-tutorial/assets/js/6.ee81796b.js"><link rel="prefetch" href="/jest-tutorial/assets/js/7.45845233.js"><link rel="prefetch" href="/jest-tutorial/assets/js/8.8fda6116.js"><link rel="prefetch" href="/jest-tutorial/assets/js/9.89aee88f.js">
    <link rel="stylesheet" href="/jest-tutorial/assets/css/0.styles.3af8d58b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/jest-tutorial/" class="home-link router-link-active"><img src="/jest-tutorial/images/logo.png" alt="Jest 实践指南" class="logo"> <span class="site-name can-hide">Jest 实践指南</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/haixiangyan/jest-tutorial/issues" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Issue
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/haixiangyan/jest-tutorial" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/haixiangyan/jest-tutorial/issues" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Issue
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/haixiangyan/jest-tutorial" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>介绍</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/jest-tutorial/" aria-current="page" class="sidebar-link">小书介绍</a></li><li><a href="/jest-tutorial/intro/why-test/" class="sidebar-link">为什么要测试</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>基础实践</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/jest-tutorial/basic/getting-started/" class="sidebar-link">起步</a></li><li><a href="/jest-tutorial/basic/transformer/" class="sidebar-link">转译器</a></li><li><a href="/jest-tutorial/basic/test-environment/" class="sidebar-link">测试环境</a></li><li><a href="/jest-tutorial/basic/navigation/" class="sidebar-link">Mock 网页地址</a></li><li><a href="/jest-tutorial/basic/tdd/" class="sidebar-link">测试驱动开发</a></li><li><a href="/jest-tutorial/basic/mock-timer/" class="sidebar-link">Mock Timer</a></li><li><a href="/jest-tutorial/basic/config-react/" class="sidebar-link">引入 React（纯配置）</a></li><li><a href="/jest-tutorial/basic/snapshot-test/" class="sidebar-link">快照测试</a></li><li><a href="/jest-tutorial/basic/component-test/" class="sidebar-link">组件测试</a></li><li><a href="/jest-tutorial/basic/how-to-mock/" aria-current="page" class="active sidebar-link">Mock 大全</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/jest-tutorial/basic/how-to-mock/#一次性-mock" class="sidebar-link">一次性 Mock</a></li><li class="sidebar-sub-header"><a href="/jest-tutorial/basic/how-to-mock/#多次-mock" class="sidebar-link">多次 Mock</a></li><li class="sidebar-sub-header"><a href="/jest-tutorial/basic/how-to-mock/#object-defineproperty" class="sidebar-link">Object.defineProperty</a></li><li class="sidebar-sub-header"><a href="/jest-tutorial/basic/how-to-mock/#奇行种" class="sidebar-link">奇行种</a></li><li class="sidebar-sub-header"><a href="/jest-tutorial/basic/how-to-mock/#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/jest-tutorial/basic/redux-test/" class="sidebar-link">Redux 测试</a></li><li><a href="/jest-tutorial/basic/hook-test/" class="sidebar-link">React Hook 测试</a></li><li><a href="/jest-tutorial/basic/static-tool/" class="sidebar-link">静态检查工具</a></li><li><a href="/jest-tutorial/basic/performance/" class="sidebar-link">Jest 性能优化</a></li><li><a href="/jest-tutorial/basic/automation/" class="sidebar-link">自动化测试</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>测试思路</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/jest-tutorial/thoughts/articles.html" class="sidebar-link">所有文章</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>最后</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/jest-tutorial/end/github.html" class="sidebar-link">Github 项目</a></li><li><a href="/jest-tutorial/end/end.html" class="sidebar-link">结语</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mock-大全"><a href="#mock-大全" class="header-anchor">#</a> Mock 大全</h1> <p>之前一直没有跟大家讲 Jest 的 Mock，就是想让大家先体会体会 Mock 的便利性以及复杂性。如果没有真正用过就看总结，
你会觉得：就这？</p> <p>在前面一些章节，我们都遇到了不少 Mock 的场景，比如 <code>window.location.href</code>、Http 请求、函数的 Mock 等等。
相信对 Jest 的 Mock 都有大致印象了，所以这一章就来总结一下 Jest Mock 的一些实用场景吧。</p> <h2 id="一次性-mock"><a href="#一次性-mock" class="header-anchor">#</a> 一次性 Mock</h2> <p>这里的 “一次性” 是指在一个文件只 Mock 一次。Jest 的官方文档 <a href="https://jestjs.io/docs/mock-functions" target="_blank" rel="noopener noreferrer">在 Mock Functions 这一章<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 写了一些这种 Mock 的用法，
这里简单说一下。</p> <h3 id="mock-模块"><a href="#mock-模块" class="header-anchor">#</a> Mock 模块</h3> <p>类似 <code>axios</code> 这样的第三方 NPM 库，可以这样实现 Mock：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Users <span class="token keyword">from</span> <span class="token string">'./users'</span><span class="token punctuation">;</span>

jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">'axios'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'should fetch users'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>name<span class="token operator">:</span> <span class="token string">'Bob'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> resp <span class="token operator">=</span> <span class="token punctuation">{</span>data<span class="token operator">:</span> users<span class="token punctuation">}</span><span class="token punctuation">;</span>
  axios<span class="token punctuation">.</span>get<span class="token punctuation">.</span><span class="token function">mockResolvedValue</span><span class="token punctuation">(</span>resp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 你也可以使用下面这样的方式：</span>
  <span class="token comment">// axios.get.mockImplementation(() =&gt; Promise.resolve(resp))</span>

  <span class="token keyword">return</span> Users<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>data <span class="token operator">=&gt;</span> <span class="token function">expect</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>但是这样的方法 <strong>并 不 好 用！</strong> 一般我们都会在项目里用 TypeScript，而 <code>axios.get</code> 是没有 <code>jest</code> 这些类型的，所以会报以下错误：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>TS2339: Property 'mockResolveValues' does not exist on type '  &gt;(url: string, config?: AxiosRequestConfig | undefined) =&gt; Promise '.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>正确的用法应该是用 <code>jest.spyOn</code> 来代替上面这种写法：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Users <span class="token keyword">from</span> <span class="token string">'./users'</span><span class="token punctuation">;</span>

jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">'axios'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'should fetch users'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>name<span class="token operator">:</span> <span class="token string">'Bob'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> resp <span class="token operator">=</span> <span class="token punctuation">{</span>data<span class="token operator">:</span> users<span class="token punctuation">}</span><span class="token punctuation">;</span>

  jest<span class="token punctuation">.</span><span class="token function">spyOn</span><span class="token punctuation">(</span>axios<span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockResolvedValue</span><span class="token punctuation">(</span>resp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 你也可以使用下面这样的方式：</span>
  <span class="token comment">// jest.spyOn(axios, 'get').mockImplementation(() =&gt; Promise.resolve(resp))</span>

  <span class="token keyword">return</span> Users<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>data <span class="token operator">=&gt;</span> <span class="token function">expect</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>如果你非要用 <code>axios.get.mockImplementation</code>，那么建议你使用 <code>ts-jest</code> 里的 <a href="https://kulshekhar.github.io/ts-jest/docs/27.1/guides/test-helpers" target="_blank" rel="noopener noreferrer">helper 函数<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <code>mocked</code>：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> mocked <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'ts-jest/utils'</span>
<span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Users <span class="token keyword">from</span> <span class="token string">'./users'</span><span class="token punctuation">;</span>

jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">'axios'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'should fetch users'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>name<span class="token operator">:</span> <span class="token string">'Bob'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> resp <span class="token operator">=</span> <span class="token punctuation">{</span>data<span class="token operator">:</span> users<span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> mockedGet <span class="token operator">=</span> <span class="token function">mocked</span><span class="token punctuation">(</span>axios<span class="token punctuation">.</span>get<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 带上 jest 的类型提示</span>
  mockedGet<span class="token punctuation">.</span><span class="token function">mockResolvedValue</span><span class="token punctuation">(</span>resp<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 含有 jest 的类型提示</span>

  <span class="token keyword">return</span> Users<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>data <span class="token operator">=&gt;</span> <span class="token function">expect</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="custom-block danger"><p class="custom-block-title">DANGER</p> <p><strong><code>ts-jest@28.0</code> 已经把 <code>mocked</code> 移除了！这个函数被放到 <code>jest-mock@27.4.0</code> 这个包里了（内置到 Jest）！</strong></p></div> <h3 id="部分依赖"><a href="#部分依赖" class="header-anchor">#</a> 部分依赖</h3> <p>上面会把整个模块的实现都给干掉，如果只想 Mock 部分内容，官方也提供了对应的写法：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// foo-bar-baz.js</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token string">'foo'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">bar</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">'bar'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">'baz'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">//test.js</span>
<span class="token keyword">import</span> defaultExport<span class="token punctuation">,</span> <span class="token punctuation">{</span>bar<span class="token punctuation">,</span> foo<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../foo-bar-baz'</span><span class="token punctuation">;</span>

jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">'../foo-bar-baz'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 真实的 foo-bar-baz 模块内容</span>
  <span class="token keyword">const</span> originalModule <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">requireActual</span><span class="token punctuation">(</span><span class="token string">'../foo-bar-baz'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Mock 默认导出和 foo 的内容</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    __esModule<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>originalModule<span class="token punctuation">,</span>
    <span class="token keyword">default</span><span class="token operator">:</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">'mocked baz'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    foo<span class="token operator">:</span> <span class="token string">'mocked foo'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'should do a partial mock'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> defaultExportResult <span class="token operator">=</span> <span class="token function">defaultExport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>defaultExportResult<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'mocked baz'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>defaultExport<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'mocked foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p><strong>要注意的是：<code>jest.mock</code> 和 <code>jest.unmock</code> 是一对非常特殊的 API，它们会被提升到所有 <code>import</code> 前。也就是说，上面这段代码看起是先 import 再 mock，而真实情况是，先 mock 了，再 import：</strong></p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// jest.mock 会被提升到所有 import 前</span>
jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">'../foo-bar-baz'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 真实的 foo-bar-baz 模块内容</span>
  <span class="token keyword">const</span> originalModule <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">requireActual</span><span class="token punctuation">(</span><span class="token string">'../foo-bar-baz'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Mock 默认导出和 foo 的内容</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    __esModule<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>originalModule<span class="token punctuation">,</span>
    <span class="token keyword">default</span><span class="token operator">:</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">'mocked baz'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    foo<span class="token operator">:</span> <span class="token string">'mocked foo'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> defaultExport<span class="token punctuation">,</span> <span class="token punctuation">{</span>bar<span class="token punctuation">,</span> foo<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../foo-bar-baz'</span><span class="token punctuation">;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'should do a partial mock'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> defaultExportResult <span class="token operator">=</span> <span class="token function">defaultExport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>defaultExportResult<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'mocked baz'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>defaultExport<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'mocked foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>只有这样你从 <code>'../foor-bar-baz'</code> 拿到的内容才是 Mock 内容。所以，也推荐大家在用 <code>jest.mock</code> 和 <code>jest.unmock</code> 这两个 API 时最好写成先 mock 后 import 来避免理解上的歧义。</p> <p>有同学会问：除了这俩还有没有别的 API 会这样提升的呢？我搜了很多地方，大家只需要记住这两就好了。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>这样的提升代码形为原本是通过 <code>babel-plugin-jest-hoist</code> 这个插件实现的，所以你在选 Jest 的转译器时，也要留意一下这些小坑。不过目前大部分的转译工具都有这个功能了。</p></div> <h2 id="多次-mock"><a href="#多次-mock" class="header-anchor">#</a> 多次 Mock</h2> <p>官网对 Mock 的展示到上面就结束了。然而，<strong>我们经常会在同一个测试文件中给对象、函数、变量进行多次 Mock，以此模拟多种用例场景。</strong></p> <p>举个例子，我们添加一个配置文件 <code>src/utils/env.ts</code>：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/utils/env.ts</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">getEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 很复杂的逻辑...</span>
    <span class="token keyword">return</span> <span class="token string">'test'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>假如我们想测试一下不同环境下的一些行为：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'环境'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'开发环境'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Mock config.getEnv =&gt; 'dev'</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'正式环境'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Mock config.getEnv =&gt; 'prod'</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>如果还用 <code>jest.mock</code> 的方法来做 Mock 的话，就有点不合适了。下面来聊聊这种需要多次 Mock 的解决方法。</p> <h3 id="domock"><a href="#domock" class="header-anchor">#</a> doMock</h3> <p>刚刚说到 <code>jest.mock</code> 会提升到整个文件最前面，这也导致我们无法再次修改 Mock 的实现。<code>jest</code> 还提供了另一个 API <code>jest.doMock</code>，它也会执行 Mock 操作，但是不会被提升。利用这个特性再加上内联 <code>require</code> 就可以实现多次 Mock 的效果了：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// tests/utils/env/doMock.test.ts</span>
<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&quot;doMock config&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 必须重置模块，否则无法再次应用 doMock 的内容</span>
    jest<span class="token punctuation">.</span><span class="token function">resetModules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'开发环境'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    jest<span class="token punctuation">.</span><span class="token function">doMock</span><span class="token punctuation">(</span><span class="token string">'utils/env'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
      __esModule<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      config<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">getEnv</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">'dev'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token punctuation">{</span> config <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'utils/env'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">getEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token string">'dev'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'正式环境'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    jest<span class="token punctuation">.</span><span class="token function">doMock</span><span class="token punctuation">(</span><span class="token string">'utils/env'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
      __esModule<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      config<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">getEnv</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">'prod'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token punctuation">{</span> config <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'utils/env'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">getEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token string">'prod'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>需要注意的是：这里一共引用了两次 <code>utils/env</code>，因此要用 <code>jest.resetModules</code> 来重置前一次引入的模块内容。</p></div> <p>不过，这个方法也太挫了。</p> <h3 id="spyon"><a href="#spyon" class="header-anchor">#</a> spyOn</h3> <p>对上面这种要多次 Mock 一个函数的情况，比较推荐的方法是用 <code>jest.spyOn</code>，添加 <code>tests/utils/env/spyOn.test.ts</code>：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// tests/utils/env/spyOn.test.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> config <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;utils/env&quot;</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&quot;spyOn config&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'开发环境'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    jest<span class="token punctuation">.</span><span class="token function">spyOn</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token string">'getEnv'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockReturnValue</span><span class="token punctuation">(</span><span class="token string">'dev'</span><span class="token punctuation">)</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">getEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token string">'dev'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'正式环境'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    jest<span class="token punctuation">.</span><span class="token function">spyOn</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token string">'getEnv'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockReturnValue</span><span class="token punctuation">(</span><span class="token string">'prod'</span><span class="token punctuation">)</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">getEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token string">'prod'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>有人看到 <code>jest.spyOn</code> 会说：这个我早就知道了。别急，我们慢慢增加难度。</p> <h3 id="对象属性"><a href="#对象属性" class="header-anchor">#</a> 对象属性</h3> <p>假如我们的 <code>env.ts</code> 中 <code>config</code> 里存不是 <code>getEnv</code> 函数，而是一个 <code>env</code> 属性：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">const</span> configObj <span class="token operator">=</span> <span class="token punctuation">{</span>
  env<span class="token operator">:</span> <span class="token string">'test'</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>改成了属性后，我们就要 Mock <code>config.env</code> 的属性值。而由于属性值不是函数，所以我们无法使用 <code>jest.spyOn</code> 来 Mock 了。</p> <p>不过，如果你学过 <a href="https://javascript.ruanyifeng.com/stdlib/attributes.html" target="_blank" rel="noopener noreferrer">阮一峰的《属性描述对象 - 7.存取器》<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ，那么你应该还记得这一章讲到：对象属性可以定义自己的 <code>getter</code> 和 <code>setter</code>：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">const</span> obj <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'p'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'getter'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setter: '</span> <span class="token operator">+</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

obj<span class="token punctuation">.</span>p <span class="token comment">// &quot;getter&quot;</span>
obj<span class="token punctuation">.</span>p <span class="token operator">=</span> <span class="token number">123</span> <span class="token comment">// &quot;setter: 123&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>我们把 <code>env.ts</code> 的代码改成以下面 <code>getter</code> 取值方式：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">const</span> configObj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'test'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>这里我们可以给 <code>config.env</code> 定义 <code>env</code> 的 <code>getter</code>，当获取 <code>config.env</code> 时，实际上相当于调用 <code>config.env</code> 的 <code>getter</code> 函数。
既然 <code>getter</code> 是个函数，我们又可以使用上面的 <code>jest.spyOn</code> 了：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// tests/utils/env/getter.test.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> configObj <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;utils/env&quot;</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&quot;configObj env getter&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'开发环境'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    jest<span class="token punctuation">.</span><span class="token function">spyOn</span><span class="token punctuation">(</span>configObj<span class="token punctuation">,</span> <span class="token string">'env'</span><span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockReturnValue</span><span class="token punctuation">(</span><span class="token string">'dev'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>configObj<span class="token punctuation">.</span>env<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token string">'dev'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'正式环境'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    jest<span class="token punctuation">.</span><span class="token function">spyOn</span><span class="token punctuation">(</span>configObj<span class="token punctuation">,</span> <span class="token string">'env'</span><span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockReturnValue</span><span class="token punctuation">(</span><span class="token string">'prod'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>configObj<span class="token punctuation">.</span>env<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token string">'prod'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><code>jest.spyOn</code> 最后一个参数是对象属性的 <code>accessType</code>（<code>get</code>），通过指定这个参数，我们就能控制对象的属性值了。</p> <h3 id="单独导出函数"><a href="#单独导出函数" class="header-anchor">#</a> 单独导出函数</h3> <p>上面的例子都是直接导出一个对象，算是比较理想的情况了。那如果 <code>env.ts</code> 导出的是一个函数呢：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/utils/env.ts</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getEnv</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">'test'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这下好了，我们连能够 <code>spyOn</code> 的对象都没了，这又该如何测呢？很简单，在导入的时候把它弄成对象就好了：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// tests/utils/env/getEnv.test.ts</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> envUtils <span class="token keyword">from</span> <span class="token string">'utils/env'</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&quot;getEnv&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'开发环境'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    jest<span class="token punctuation">.</span><span class="token function">spyOn</span><span class="token punctuation">(</span>envUtils<span class="token punctuation">,</span> <span class="token string">'getEnv'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockReturnValue</span><span class="token punctuation">(</span><span class="token string">'dev'</span><span class="token punctuation">)</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>envUtils<span class="token punctuation">.</span><span class="token function">getEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token string">'dev'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'正式环境'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    jest<span class="token punctuation">.</span><span class="token function">spyOn</span><span class="token punctuation">(</span>envUtils<span class="token punctuation">,</span> <span class="token string">'getEnv'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockReturnValue</span><span class="token punctuation">(</span><span class="token string">'prod'</span><span class="token punctuation">)</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>envUtils<span class="token punctuation">.</span><span class="token function">getEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token string">'prod'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>有没有感觉开始魔幻起来了？</p> <h3 id="直接导出变量"><a href="#直接导出变量" class="header-anchor">#</a> 直接导出变量</h3> <p>再极端点，这次不直接导出 <code>getEnv</code> 函数，而是导出 <code>env</code> 变量：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/utils/env.ts</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> env <span class="token operator">=</span> <span class="token string">'test'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>聪明的同学会想到把 <code>import * as envUtils</code> 和 <code>spyOn env getter</code> 的方法：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// tests/utils/env/env.test.ts</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> envUtils <span class="token keyword">from</span> <span class="token string">'utils/env'</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&quot;env&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'开发环境'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// @ts-ignore</span>
    jest<span class="token punctuation">.</span><span class="token function">spyOn</span><span class="token punctuation">(</span>envUtils<span class="token punctuation">,</span> <span class="token string">'env'</span><span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockReturnValue</span><span class="token punctuation">(</span><span class="token string">'dev'</span><span class="token punctuation">)</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>envUtils<span class="token punctuation">.</span>env<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token string">'dev'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'正式环境'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// @ts-ignore</span>
    jest<span class="token punctuation">.</span><span class="token function">spyOn</span><span class="token punctuation">(</span>envUtils<span class="token punctuation">,</span> <span class="token string">'env'</span><span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockReturnValue</span><span class="token punctuation">(</span><span class="token string">'prod'</span><span class="token punctuation">)</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>envUtils<span class="token punctuation">.</span>env<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token string">'prod'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>这里 TS 已经提示我们不能把 <code>dev</code> 和 <code>prod</code> 赋值给 <code>test</code> 了，没关系，我们先用 <code>@ts-ignore</code> 忽略它。硬着头皮换来的结果就是报错：</p> <p><img src="data:image/png;base64,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" alt=""></p> <p>这里又为什么不能监听属性值的 <code>getter</code> 呢？因为这里的 <code>envUtils</code> 没有定义 <code>getter</code> accessor，所以这里无法使用 <code>jest.spyOn</code> 了。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>这里我也搜了一下，发现 <a href="https://github.com/facebook/jest/issues/9675" target="_blank" rel="noopener noreferrer">这个 Issue: spyOn getter only works for static getters and not for instance getters<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。
<code>jest</code> 只能监听对象静态属性的 <code>getter</code> 而不能监听对象实例的属性，大家也要注意一下这个点。</p></div> <p>要解决这个问题，我们可以通过强行赋值来解决它：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> envUtils <span class="token keyword">from</span> <span class="token string">'utils/env'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> originEnv <span class="token operator">=</span> envUtils<span class="token punctuation">.</span>env<span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&quot;env&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">afterEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// @ts-ignore</span>
    envUtils<span class="token punctuation">.</span>env <span class="token operator">=</span> originEnv<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'开发环境'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// @ts-ignore</span>
    envUtils<span class="token punctuation">.</span>env <span class="token operator">=</span> <span class="token string">'dev'</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>envUtils<span class="token punctuation">.</span>env<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token string">'dev'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'正式环境'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// @ts-ignore</span>
    envUtils<span class="token punctuation">.</span>env <span class="token operator">=</span> <span class="token string">'prod'</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>envUtils<span class="token punctuation">.</span>env<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token string">'prod'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>这里依然要用 <code>@ts-ignore</code> 来解决 “不能把 <code>dev</code> 和 <code>prod</code> 赋值给 <code>test</code>” 的报错，而且还要把 <code>export const env = 'test'</code>
改成 <code>export let env = 'test'</code> 才能进行赋值。多少有点挫了。</p> <p>要解决上面这些问题，我们请出 Jest Mock 里最万能的方法 —— <code>Object.defineProperty</code>：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> envUtils <span class="token keyword">from</span> <span class="token string">'utils/env'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> originEnv <span class="token operator">=</span> envUtils<span class="token punctuation">.</span>env<span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&quot;env&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">afterEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>envUtils<span class="token punctuation">,</span> <span class="token string">'env'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      value<span class="token operator">:</span> originEnv<span class="token punctuation">,</span>
      writable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'开发环境'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>envUtils<span class="token punctuation">,</span> <span class="token string">'env'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      value<span class="token operator">:</span> <span class="token string">'dev'</span><span class="token punctuation">,</span>
      writable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>envUtils<span class="token punctuation">.</span>env<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token string">'dev'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'正式环境'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>envUtils<span class="token punctuation">,</span> <span class="token string">'env'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      value<span class="token operator">:</span> <span class="token string">'prod'</span><span class="token punctuation">,</span>
      writable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>envUtils<span class="token punctuation">.</span>env<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token string">'prod'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>这样我们既不需要用 <code>@ts-ignore</code> 也不需要把 <code>const</code> 改成 <code>let</code> 了。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p><strong>要注意的是，无论用直接赋值还是 <code>Object.defineProperty</code>，都需要在最开始记录 <code>env</code> 的值，然后加一个 <code>afterEach</code> 在执行每个用例后又赋值回去，否则会造成用例之间的污染！</strong></p></div> <p>上面就是在同一个文件里对不同测试用例多次 Mock 的一些技巧，基本能覆盖到 80% 的测试场景。</p> <h2 id="object-defineproperty"><a href="#object-defineproperty" class="header-anchor">#</a> Object.defineProperty</h2> <p>相信看到上面最后一个例子的同学可能会震惊：<code>Object.defineProperty</code> 我一年都没用几次，这样做是不是不太正规呀？错了，这个 API 在前端测试的 Mock 里非常常见，
也是最万能的 Mock 方法。</p> <p>比如，我们这里的 <code>env</code> 取的是 <code>window.env</code> 的全局变量时，你也可以用它来 Mock：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code>Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> <span class="token string">'env'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  value<span class="token operator">:</span> <span class="token string">'dev'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>虽然这个 API 很强大，但是使用时会污染到别的测试用例，因此你需要在每个用例执行完后重新赋一次原来的值。而当你用它来 Mock 公共内容时，
比如 <code>String.split</code>,<code>Array.map</code>，你会污染所有测试文件！因此，不得万不得已，尽量不用它，应该看看有没有更好的 Mock 方法，或者换种测试策略。</p> <h2 id="奇行种"><a href="#奇行种" class="header-anchor">#</a> 奇行种</h2> <p>一路看起来，你会发现 Jest 的 Mock 方式非常 Hacky，然而我在搜索 Jest 的 Mock 技巧时，还发现了一些更 Hacky 的 <a href="https://github.com/magicmark/jest-how-do-i-mock-x" target="_blank" rel="noopener noreferrer">奇行种<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ，下面分享两个：</p> <h3 id="依赖注入"><a href="#依赖注入" class="header-anchor">#</a> 依赖注入</h3> <p>我们经常会遇到这样的情况：同一个文件中，A 函数里调用了 B 函数。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getPlanet</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">'world'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">getGreeting</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">hello </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getPlanet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">!</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>这里我们希望通过 Mock <code>getPlanet</code> 的不同值来检查 <code>getGreeting</code> 的返回值。解决这个问题的关键思路是引入默认变量：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getPlanet</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">'world'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">getGreeting</span> <span class="token punctuation">(</span>_getPlanet <span class="token operator">=</span> getPlanet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">hello </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">_getPlanet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">!</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>然后在写测试时，用一个外部的 <code>getPlanet</code> 来替代同文件里的 <code>getPlanet</code>：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> getGreeting <span class="token keyword">from</span> <span class="token string">'../greeting.dependency-injection'</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'getGreeting'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'默认值'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">getGreeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'hello world!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'输出 mars'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">getGreeting</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">'mars'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'hello mars!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'输出 jupiter'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">getGreeting</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">'jupiter'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'hello jupiter!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'回到默认值'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">getGreeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'hello world!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>这就可以在不修改 <code>getGreeting</code> 的用法前提下实现 Mock，但是万一以后要添加参数了，这个方法还不是特别保险。</p> <h3 id="改写文件内容"><a href="#改写文件内容" class="header-anchor">#</a> 改写文件内容</h3> <p>这个就更奇葩了，直接改写文件内容。一般在测 <code>fs</code> 模块相关代码时，比如清理文件内容，追加文件内容等，我们会希望某个目录下已经有对应的内容了，而不是自己创建文件。
这时你可以使用 <code>fs</code> 提供的 <code>__setVolumeContents</code> 来实现：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> cleanDirectory <span class="token keyword">from</span> <span class="token string">'../clean-directory'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> fs<span class="token punctuation">,</span> <span class="token punctuation">{</span> __setVolumeContents<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'fs'</span><span class="token punctuation">;</span>

jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// check out ../__mocks__/fs.js to see why this works!</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'cleanDirectory() wipes away contents of /foo/bar/baz with 2 files'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">__setVolumeContents</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string-property property">'/foo/bar/baz/qux1.txt'</span><span class="token operator">:</span> <span class="token string">'hello'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'/foo/bar/baz/qux2.txt'</span><span class="token operator">:</span> <span class="token string">'world'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> numFilesDeleted <span class="token operator">=</span> <span class="token function">cleanDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>numFilesDeleted<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span><span class="token string">'/foo/bar/baz'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveLength</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'cleanDirectory() wipes away contents of /foo/bar/baz with 3 files'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">__setVolumeContents</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string-property property">'/foo/bar/baz/one.txt'</span><span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'/foo/bar/baz/two.txt'</span><span class="token operator">:</span> <span class="token string">'2'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'/foo/bar/baz/three.txt'</span><span class="token operator">:</span> <span class="token string">'3'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> numFilesDeleted <span class="token operator">=</span> <span class="token function">cleanDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>numFilesDeleted<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span><span class="token string">'/foo/bar/baz'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveLength</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>不过我没有使用过这个方法，个人觉得还是写一个脚本放在 <code>utils</code> 里去自动创建需要的测试文件比较好，而不是用这种 Hacky 的方式。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>这一章里，我们学会了一些 Mock 技巧：</p> <ul><li><code>jest.mock</code> 会提升到整个文件的顶端，先 mock 再 import</li> <li>可以用 <code>ts-jest</code> 提供的 <code>mocked</code> 函数让被 Mock 的函数自动拥有 <code>jest</code> 类型提示，不过这个已在 <code>ts-jest@28.0</code> 中被移除，放到了 <code>jest</code> 自带的 <code>jest-mock</code> 库中</li> <li><code>doMock</code> + 内联导入模块确实能解决修改 Mock 值的问题，但是太挫了，不推荐使用</li> <li>可以用 <code>spyOn</code> 来监听函数以及对象属性的 <code>getter</code> 来修改返回值</li> <li>可以用 <code>Object.defineProperty</code> 来更改变量值以及对象属性值，不过，这个方法也会带来一些副作用，需要手动重置修改过的值</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新:</span> <span class="time">5/13/2022, 9:41:35 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/jest-tutorial/basic/component-test/" class="prev">
        组件测试
      </a></span> <span class="next"><a href="/jest-tutorial/basic/redux-test/">
        Redux 测试
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/jest-tutorial/assets/js/app.dfa51a05.js" defer></script><script src="/jest-tutorial/assets/js/2.03a6ea53.js" defer></script><script src="/jest-tutorial/assets/js/18.8509fe90.js" defer></script>
  </body>
</html>
